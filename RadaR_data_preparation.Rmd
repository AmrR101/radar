---
title: "Data for RadaR"
author: "Christian Luz"
date: "2018-06-13"
output: html_document
---

## Loading required packages and raw data

```{r echo = FALSE}
library(tidyverse)
library(lubridate)
library(readxl)
library(timeDate)
library(AMR)

admission_raw <- read_csv("admission.csv")
```

# Admission data
<br>
### Check number of missing observations per variable

```{r}
check_na <- function(x) {
  column <- vector("character")
  na_sum <- vector("integer")
  for (i in seq_along(x)) {
    na_sum[i] <- sum(is.na(x[i]))
    column[i] <- colnames(x[i])
  }
  tibble(column, na_sum) %>% arrange(-na_sum)
}

check_na(admission_raw)
```

### Drop observations with missing essential variables

```{r}
admission <- admission_raw %>%
  drop_na(
    patient_number,
    adm_number,
    adm_year,
    adm_start_date,
    adm_end_date,
    birth_date,
    gender,
    sub_specialty,
    specialty,
    adm_route
  )
```

### Transform dates to YYYY-MM-DD format

```{r}
# find and replace non-English month names and standardize dates

standard_date <- function(df, column, date_format = mdy_hms) {
  str_replace_all(df[[column]], c("mrt" = "mar", "mei" = "may", "okt" = "oct")) %>%
    date_format() %>%
    as.Date()
}


# birth_date
admission$birth_date <- standard_date(admission, "birth_date")
# adm_start_date
admission$adm_start_date <- standard_date(admission, "adm_start_date")
# adm_end_date
admission$adm_end_date <- standard_date(admission, "adm_end_date")
# patient_death_date
admission$patient_death_date <- standard_date(admission, "patient_death_date")
```

### Recode patient death as logical variable
<br>
In our dataset patient death is coded as `+`. This is into `TRUE` or `FALSE`. A new variable for death during admission is created.

```{r}

admission$patient_death <- if_else(admission$patient_death == "+", TRUE, FALSE, missing = FALSE)

admission <- admission %>%
  mutate(death_during_adm = if_else(patient_death_date - adm_end_date == 0, TRUE, FALSE))
```


### Find and exclude data errors
<br>
Our dataset included two types of data errors. 1.) Records with missing first admission rank number. These observations are dropped due to missing information. 2.) Double admissions in the dataset are identified and subsequently deleted. To detect the double admissions the admission id needs to be a running number that reflects consecutive admissions. Admissions with the same end date but higher admission id where identified to be false and are therefore excluded.

```{r}
# filter for admissions with correct information for first admission rank numbers:
admission <- admission %>% group_by(patient_number, adm_number, adm_year) %>% filter(any(adm_rank == 1)) %>% ungroup()

# identify double admission
double_admissions <- admission %>%
  group_by(patient_number, adm_end_date) %>%
  count() %>%
  filter(n > 1) %>%
  left_join(admission, by = c("patient_number", "adm_end_date")) %>%
  ungroup()

double_admissions <- double_admissions %>%
  arrange(patient_number, adm_end_date, adm_number) %>%
  group_by(patient_number, adm_end_date) %>%
  mutate(correct_adm_number = if_else(adm_number <= lag(adm_number), TRUE, FALSE)) %>%
  filter(correct_adm_number == FALSE) %>%
  ungroup() %>%
  select(patient_number, adm_number, adm_year, adm_end_date)

admission <- admission %>% anti_join(double_admissions)
```

### Exclude coding in errors for dates, calculate patient age, weekday, year, quarter, length of stay variable

```{r}
# exclude false birth dates
admission <- admission[!(admission$birth_date > Sys.Date()), ]

# create age, weekday and quarter variable
admission <- admission %>%
  mutate(age = as.integer((adm_start_date - birth_date) / 365)) %>%
  mutate(adm_weekday = isWeekday(adm_start_date)) %>%
  mutate(year = year(adm_start_date)) %>%
  mutate(quarter = quarter(adm_start_date)) %>%
  mutate(yearquarter = paste(year, "-", quarter)) # in a YYYY-Q format
```

### Group observations to calculate lenght of stay and join to final dataframe 

```{r}
grouped_stay <- admission %>%
  group_by(patient_number, adm_number, adm_year) %>%
  summarise(
    adm_start_date = min(adm_start_date),
    adm_end_date = max(adm_end_date)
  ) %>%
  mutate(LOS = (adm_end_date - adm_start_date) + 1)

admission <- grouped_stay %>%
  left_join(admission %>%
    filter(adm_rank == 1) %>%
    select(-adm_start_date, -adm_end_date), 
    by = c("patient_number", "adm_number", "adm_year"))

```

### Selecting variables needed for RadaR and recode specialty and admitting department.

```{r}
admission <- admission %>% 
  select(
    patient_number,
    adm_number, 
    adm_year,
    adm_start_date,
    adm_end_date,
    LOS,
    adm_weekday,
    year,
    yearquarter,
    gender,
    age,
    birth_date,
    specialty,
    adm_route,
    death_during_adm
  )


admission$adm_route <- admission$adm_route %>% 
  recode(
    "HAPS" = "home", 
    "EHBO" = "home", 
    "ELD" = "home", 
    "POLI" = "home", 
    "WOOX" = "home", 
    "WOON" = "home", 
    "VROE" = "home",
    "HUAR" = "gp",
    "GGZI" = "psychiatry",
    "GUMC" = "newborn",
    "OVIN" = "other",
    "REVI" = "rehabilitation",
    "UMC" = "university hospital",
    "GUMC" = "newborn", 
    "VERP" = "nursing home",
    "XXX" = "unknown",
    "ZKHA" = "hospital", 
    "ZKHB" = "hospital", 
    "ZKHS" = "hospital", 
    "ZKHC" = "hospital", 
    "ZKPO" = "hospital",
    "N/A" = "unknown"
  )

admission$adm_route[is.na(admission$adm_route)] <- "unknown"

admission$specialty <- admission$specialty %>%
  recode(
  "ANA" =	"Anesthesiologie",
  "APC" =	"Anesthesiologie Pyn Centrum",
  "CAB"	= "Chirurgie Abdominaal",
  "CAI"	= "Chirurgie Abdominaal Int. Care",
  "CAO"	= "DBC ondersteuning Cardiologie",
  "CHE"	= "Chirurgie Heelkunde",
  "CHI"	= "Chirurgie Hepato-Biliair IC",
  "CHP"	= "Chirurgie Hepato-Biliair",
  "CKC"	= "Chirurgie Kinderchir.",
  "CLI"	= "Chir.Levertranspl. Int. Care",
  "CLT"	= "Chir. Levertransplantatie",
  "COI"	= "Chir. Oncologie Intensive Care",
  "CON"	= "Chirurgie Oncologie",
  "CPI"	= "Plastische Chirurgie Int. Care",
  "CPL"	= "Chirurgie Plastische Chir.",
  "CTI"	= "Chir.Traumatologie Int. Care",
  "CTR"	= "Traumachirurgie",
  "CTX"	= "Chirurgie Transplantatie",
  "CUR"	= "Urologie",
  "CVA"	= "Chirurgie Vaat-Chir.",
  "CVI"	= "Chir.Vaatchirurgie Int. Care",
  "DEA"	= "Dermatologie Algemeen",
  "EPL"	= "Esthetische Plastische Chir.",
  "IAI"	= "Interne Algemene Infectie",
  "IAL"	= "Interne Algemeen",
  "IAO"	= "Medische Oncologie",
  "ICK"	= "Intensive Care Kinderen",
  "ICV"	= "Intensive Care Volwassenen",
  "IDI"	= "Int. Dunne Darm Transplant IC",
  "IDX"	= "Interne Dunne Darm Transplant.",
  "IEN"	= "Interne Endocrinologie",
  "IGH"	= "Maag-Darm-Leverziekten",
  "IGI"	= "Int. maag,darm leverziekten IC",
  "IGR"	= "Interne Geriatrie",
  "IHD"	= "Hematologie Donoren",
  "IHI"	= "Interne Hematologie IC",
  "IHM"	= "Hematologie",
  "IHT"	= "Hematologie Transplantatie",
  "IKI"	= "Interne Klinische Immunolog.",
  "ILI"	= "Longziekten&TBC Intensive Care",
  "ILN"	= "Longziekten&TBC Transplantatie",
  "ILO"	= "Longziekten&TBC Oncologie",
  "ILT"	= "Interne Lever Transplantatie",
  "ILZ"	= "Longziekten&TBC Algemeen",
  "INC"	= "Interne Geneesk.Intensive Care",
  "INE"	= "Interne Nefrologie",
  "INF"	= "Interne Infectieziekten",
  "INT"	= "Interne Niertransplantatie",
  "IOI"	= "Interne Med. Oncologie IC",
  "IRE"	= "Reumatologie&Kl.Imm.",
  "IRI"	= "Reumatologie & Kl.Imm. IC",
  "ISA"	= "Systeem Ziekten Algemene",
  "ISN"	= "Systeem Ziekten Nefrologie",
  "ITB"	= "Longziekten&TBC Thuisbeademing",
  "IYI"	= "Interne Allergie Int. Care",
  "IYY"	= "Interne Allergie",
  "KIA"	= "Kinderkliniek Algemeen",
  "KIC"	= "Kinderkliniek Cardiologie",
  "KIE"	= "Kinderkliniek Endocrinologie",
  "KIG"	= "Kinderkliniek Gastro-Entero.",
  "KIH"	= "Kinderkliniek Hematologie",
  "KII"	= "Kinderkliniek Inborn Errors",
  "KIK"	= "Kindergeneeskunde Infectiezk",
  "KIL"	= "Kinderkliniek Longziekten",
  "KIM"	= "Kinderkliniek Auto-Immuun",
  "KIN"	= "Kinderkliniek Nierziekten",
  "KIO"	= "Kinderkliniek Oncologie",
  "KIP"	= "Kindergeneeskunde Gedragsst.",
  "KIS"	= "Kindergeneeskunde Allergologie",
  "KIT"	= "Kindergeneesk Thuisbeademing",
  "KIZ"	= "Kinderkliniek Zuigelingen",
  "KLT"	= "Kinderkliniek Levertranspl.",
  "KLX"	= "Kindergeneeskunde Longtrans.",
  "KNA"	= "KNO Audiologie",
  "KNI"	= "Keel,neus- en oorheelkunde IC",
  "KNO"	= "Keel Neus Oor Heelkunde",
  "LTB"	= "Longziekten - TBC",
  "MBT"	= "Mondheelkunde Byz. Tandh.kunde",
  "MOA"	= "MKA Chirurgie Algemeen",
  "MOI"	= "MKA Orale Implantologie",
  "MOO"	= "MKA Chirurgie Oncologie",
  "NCA"	= "Neurochirurgie Algemeen",
  "NCI"	= "Neurochirurgie Intensive Care",
  "NCN"	= "Neurochirurgie Neuromodulatie",
  "NEA"	= "Neurologie Algemeen",
  "NEB"	= "Neurologie Bew.stoornis",
  "NEI"	= "Neurologie Intensive Care",
  "NEK"	= "Neurologie Kinderen",
  "NEN"	= "Neurologie Neuromodulatie",
  "NET"	= "Neurologie Traumatologie",
  "NPP"	= "Punt voor Parkinson",
  "OAC"	= "OZG Abdominale Chirurgie",
  "OHA"	= "Oogheelkunde Algemeen",
  "ORA"	= "Orthopedie Algemeen",
  "ORI"	= "Orthopedie Intensive Care",
  "PSA"	= "Psychiatrie Algemeen",
  "PSI"	= "Psychiatrie Intensief Cluster",
  "PSO"	= "UCP Ouderen Psychiatrie",
  "PSP"	= "Psychiatrie Psychosen",
  "PSS"	= "Psychiatrie Stemmingstoornis",
  "RDA"	= "Radiologie Algemeen",
  "REA"	= "Revalidatie Algemeen",
  "RTA"	= "Radiotherapie",
  "SPO"	= "Sportgeneeskunde",
  "TCA"	= "Thoraxcentrum Cardiologie",
  "TCI"	= "Cardiologie Intensive Care",
  "TCL"	= "Thorax Cardiologie Lipiden",
  "TCO"	= "Thorax Cardio Congenitaal",
  "TCR"	= "Thorax Cardio Ritme",
  "THA"	= "Thoraxcentrum Hartchirurgie",
  "THC"	= "Congenitaal hartcentrum",
  "THI"	= "Cardiopulmonale Chirurgie IC",
  "THX"	= "Thoraxcentrum Harttransplan.",
  "TIC"	= "Congenitaal Hartcentrum IC",
  "TLO"	= "Thoraxcentrum Longchirur./Ov",
  "TLX"	= "Thorax Longtransplantatie",
  "UIC"	= "Urologie Intensive Care",
  "URO"	= "DBC ondersteuning Urologie",
  "VGI"	= "Obst. & Gyn. I.C.",
  "VGY"	= "Obst & Gyn Gynaecologie",
  "VIV"	= "Obst & Gyn In-Vitro-Fertilis.",
  "VON"	= "Obst & Gyn Oncologie",
  "VVE"	= "Obst & Gyn Verloskunde",
  "VVG"	= "Obst & Gyn Voortpl.geneesk.",
  "XXX"	= "Unknown"
  )

surgery <- "\\b(chir|transp|gyn|uro|mka|tandh|ortho|keel|trauma|oog)\\b"

other <- "Anesthesiologie|Anesthesiologie Pyn Centrum|KNO Audiologie|Psychiatrie Algemeen|Psychiatrie Intensief Cluster|Psychiatrie Psychosen|Psychiatrie Stemmingstoornis|Punt voor Parkinson|Radiologie Algemeen|Revalidatie Algemeen|Sportgeneeskunde|UCP Ouderen Psychiatrie|Unknown"


# Recode specialty into broader category and keep sub-specialties

specialties <- admission %>%
  ungroup() %>%
  select(specialty) %>%
  distinct() %>%
  rename(sub_specialty = specialty) %>%
  mutate(
    specialty =
      case_when(
        str_detect(
          tolower(sub_specialty), paste(c(
            "chir",
            "transp",
            "gyn",
            "uro",
            "mka",
            "tandh",
            "ortho",
            "keel",
            "trauma",
            "oog"
          ), collapse = "|")
        ) ~ "Surgery",
        str_detect(sub_specialty, paste(c(
          "Anesthesiologie",
          "Anesthesiologie Pyn Centrum",
          "KNO Audiologie",
          "Psychiatrie Algemeen",
          "Psychiatrie Intensief Cluster",
          "Psychiatrie Psychosen",
          "Psychiatrie Stemmingstoornis",
          "Punt voor Parkinson",
          "Radiologie Algemeen",
          "Revalidatie Algemeen",
          "Sportgeneeskunde",
          "UCP Ouderen Psychiatrie",
          "Unknown"
        ), collapse = "|")) ~ "Other",
        TRUE ~ "Internal medicine"
      )
  )

admission <- admission %>% 
  rename(sub_specialty = specialty) %>% 
  left_join(specialties)

```



# Antimicibrobial consumption
<br>
### Check number of missing observations per variable

```{r}
# load antimicrobial data
antimicrobials_raw <- read_csv("antimicrobials.csv"))


check_na(antimicrobials_raw)
```

### Drop observations with missing essential variables

```{r}
antimicrobials <- antimicrobials_raw %>%
  drop_na(
    patient_number,
    ab_start_date,
    ab_stop_date,
    ab_label
  )

antimicrobials <- antimicrobials %>% 
  select(patient_number,
         ab_label, 
         ab_rhythm,
         ab_dose,
         atc_code,
         ab_start_date, 
         ab_stop_date)
```

### Standardize patient ID

```{r}
antimicrobials$patient_number <- str_pad(
  antimicrobials$patient_number,
  width = 7,
  side = "left",
  pad = "0"
)
```
### Transform dates to YYYY-MM-DD format

```{r}
# antimicrobial start date
antimicrobials$ab_start_date <- standard_date(antimicrobials, "ab_start_date", date_format = dmy)
antimicrobials$ab_stop_date <- standard_date(antimicrobials, "ab_stop_date", date_format = dmy)
```


### Check for duplicates and make observations unique.

```{r}
antimicrobials <- antimicrobials %>% distinct(.keep_all = TRUE)
```

### Standardize dosing format and calculate consumption
```{r}

# detect dosing interval

# first check values of ab_rhythm

levels(as.factor(antimicrobials$ab_rhythm))


# detect dosing count per interval

antimicrobials <- antimicrobials %>%
  mutate(
    dosing_interval_count =
      as.numeric(
        case_when(
          str_detect(ab_rhythm, "1") ~ 1,
          str_detect(ab_rhythm, "2") ~ 2,
          str_detect(ab_rhythm, "3") ~ 3,
          str_detect(ab_rhythm, "4") ~ 4,
          str_detect(ab_rhythm, "5") ~ 5,
          str_detect(ab_rhythm, "6") ~ 6,
          str_detect(ab_rhythm, "7") ~ 7,
          str_detect(ab_rhythm, "1") ~ 8,
          str_detect(ab_rhythm, "9") ~ 9,
          str_detect(ab_rhythm, "10") ~ 10,
          str_detect(ab_rhythm, "11") ~ 11,
          str_detect(ab_rhythm, "12") ~ 12,
          str_detect(ab_rhythm, coll("Conti", ignore_case = TRUE)) ~ 1,
          str_detect(ab_rhythm, coll("Zonod", ignore_case = TRUE)) ~ 1,
          str_detect(ab_rhythm, coll("Inter", ignore_case = TRUE)) ~ 1,
          str_detect(ab_rhythm, coll("N/A", ignore_case = TRUE)) ~ 0,
          str_detect(ab_rhythm, coll("Anders", ignore_case = TRUE)) ~ 1
        )
      )
  )

# standardise and check values of ab_dose

antimicrobials$ab_dose <- as.numeric(gsub(",", ".", gsub("\\.", "", antimicrobials$ab_dose)))

# calculate actual dose received per day

antimicrobials <- antimicrobials %>% 
  mutate(dose_per_day = dosing_interval_count*ab_dose)


```

### Loading data on antimicrobials used at our institution (UMCG) for detailed data based on name of the agents

```{r}
umcg_antimicrobials <- all_antimicrobials <- read_delim("all_antimicrobials.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE, na = c("NA", "", NA, "NULL"))

# variables in the raw data:
colnames(umcg_antimicrobials)

umcg_antimicrobials <- umcg_antimicrobials %>% 
  rename(atc_code = "ATC Code",
         ab_label = "Etiketnaam",
         ab_route = "Route",
         ab_unit_value = "sterkte aantal", 
         ab_unit = "sterkte eenheid") %>% 
  select(atc_code, ab_route, ab_label, ab_unit_value, ab_unit, factor)


# make units lower case
umcg_antimicrobials$ab_unit <- tolower(umcg_antimicrobials$ab_unit)

# check units
unique(umcg_antimicrobials$ab_unit)

# delete double entries

umcg_antimicrobials <- distinct(umcg_antimicrobials)


```

### Adding official WHO DDD to the institution data by using the AMR package

```{r}

# standardize administration variable

unique(umcg_antimicrobials$ab_route) # check the available values

# rename route of admininstration to official WHO DDD abbreviations for atc_property funciton (next step)
umcg_antimicrobials <- 
  umcg_antimicrobials %>% 
  mutate(ab_route_ddd = 
           case_when(
             ab_route == "IV" ~ "P",
             ab_route == "PO" ~ "O",
             ab_route == "INH" ~ "Inhal.powder",
             ab_route == "INH.S" ~ "Inhal.solution",
             ab_route == "IMP" ~ "Implant",
             ab_route == "IM" ~ "P",
             TRUE ~ NA_character_
           ))

# get the official WHO DDD and the unit
atc_codes_for_ddd <- umcg_antimicrobials %>%
  select(atc_code, ab_route_ddd) %>%
  distinct() %>%
  filter(!is.na(atc_code)) %>%
  rowwise() %>%
  mutate(
    ddd =
      atc_property(
        atc_code = atc_code,
        property = "DDD",
        administration = ab_route_ddd
      ),
    ddd_unit =
      atc_property(
        atc_code = atc_code,
        property = "U",
        administration = ab_route_ddd
      ),
    ab_type = 
      atc_property(
        atc_code = atc_code,
        property = "Name",
        administration = ab_route_ddd
      )
  )

# get the ATC group name

atc_groups <- function(ATC) {
  page <- xml2::read_html(
    paste0("https://www.whocc.no/atc_ddd_index/?code=",
           ATC,
           "&showdescription=no")) %>%
    rvest::html_node("#content") %>%
    rvest::html_children() %>%
    rvest::html_node("a")
 
  # get URLS of items
  hrefs <- page %>% rvest::html_attr("href")
  # get text of items
  texts <- page %>% rvest::html_text()
  # select only text items where URL like "code="
  texts <- texts[grepl("?code=", tolower(hrefs), fixed = TRUE)]
  # last one is antibiotics, skip it
  texts[1:length(texts) - 1]
}

atc_codes_for_ddd <- atc_codes_for_ddd %>% 
  rowwise() %>% 
  mutate(ab_group = 
           atc_groups(atc_code)[4])


umcg_antimicrobials <- umcg_antimicrobials %>%
  left_join(atc_codes_for_ddd)

```



### Merging to antimicrobials and umcg_antimicrobials to standardize dosing in DDD

```{r}
# delete atc_code from antimicrobials, only atc_code from umcg_antimicrobials will be used
antimicrobials$atc_code <- NULL

# joining antimicrobial data
antimicrobials <- antimicrobials %>% 
  left_join(umcg_antimicrobials, by = c("ab_label"))

# check for matching units of ab_route_ddd and ab_unit for daily dose in ddd

antimicrobials <-
  antimicrobials %>%
  separate(ab_unit, into = "ab_unit_clean", sep = "/") %>%
  mutate(
    ddd_per_day =
      if_else(
        ab_unit_clean != ddd_unit & ab_unit_clean == "mg",
        dose_per_day/factor,
        dose_per_day
      )
  )

# calculate treatment duration & total ddd per prescription

antimicrobials <- antimicrobials %>% 
  mutate(ab_days = ab_stop_date - ab_start_date + 1,
         ddd_per_prescription = as.numeric(ab_days)*ddd_per_day)

```


# Microbiology data
<br>
### Check number of missing observations per variable

```{r}
# load microbiology data
microbiology_raw <- read_csv("microbiology.csv")

check_na(microbiology_raw)
```

### Exclude missing essential data

```{r}
microbiology <- microbiology_raw %>%
  drop_na(
    patient_number,
    test_date,
    material
  )
```

### Standardize patient ID

```{r}
microbiology$patient_number <- str_pad(
  microbiology$patient_number,
  width = 7,
  side = "left",
  pad = "0"
)
```
### Transform dates to YYYY-MM-DD format

```{r}
# antimicrobial start date
microbiology$test_date <- standard_date(microbiology, "test_date", date_format = ymd)
```


### Check for duplicates and make observations unique.

```{r}
microbiology <- microbiology %>% distinct(.keep_all = TRUE)
```


### Add fullnames to positive cultures (using the AMR package)

```{r}
microbiology_positive <- microbiology %>%
  filter(!is.na(bact)) %>%
  left_join(microorganisms.umcg, by = c("bact" = "mocode")) %>% # from AMR package
  left_join(microorganisms, by = c("bactid"))


microbiology <- microbiology %>%
  filter(is.na(bact)) %>% # filter for negatives
  bind_rows(microbiology_positive) # join with positives
```

# Join admission, antimicrobial and microbiology data into one dataset
### Microbiology and antimicrobial data needs to be filtered for being within the interval of admission dates as data from these sources doesn't include admission numbers or any other common identifier except patient_number
<br>
### Admission data + microbiology data

```{r}
final_set <- admission %>%
  left_join(microbiology)

final_set_tests <- final_set %>%
  filter(test_date %within% interval(adm_start_date, adm_end_date))

final_set <- final_set %>%
  filter(is.na(test_date)) %>%
  bind_rows(final_set_tests)
```
<br>

### Next step + antimicrobial data

```{r}
final_set <- final_set %>%
  left_join(antimicrobials)

final_set_antimicrobials <- final_set %>%
  filter(ab_start_date %within% interval(adm_start_date, adm_end_date))

final_set <- final_set %>%
  filter(is.na(ab_start_date)) %>%
  bind_rows(final_set_antimicrobials)

```

### Calculate treatment duration, first prescriptions and total DDD per patient stay in hospital

```{r}
final_set <- final_set %>%
  arrange(
    patient_number,
    adm_year,
    adm_number,
    adm_start_date,
    ab_start_date
  ) %>%
  group_by(patient_number, adm_year, adm_number) %>%
  mutate(ab_first = 
           if_else(ab_start_date == min(ab_start_date), TRUE, FALSE)) %>% # prescription on treatment start
  mutate(ab_is_continuous = # check for continuing prescrptions (to calculate minimum duration) 
           if_else(ab_start_date - lag(ab_stop_date, min(50, row_number())) <= 1, TRUE, FALSE))

final_set$ab_is_continuous[is.na(final_set$ab_is_continuous)] <- FALSE

final_set <- final_set %>%
  mutate(ab_timing = ab_start_date - adm_start_date)

final_set_cont <- final_set %>% # important step to calculate the number of treatment days etc. as no common identifier exists in antimicrobial or microbiological datasets
  group_by(patient_number, adm_year, adm_number) %>%
  filter(
    (ab_first == TRUE) |
    (ab_is_continuous == TRUE & lag(ab_first == TRUE)) |
    (ab_is_continuous == TRUE & lag(ab_is_continuous == TRUE))
    ) %>%
  summarise(
    ab_start_all = min(ab_start_date), # define start and stop of overall treatment
    ab_stop_all = max(ab_stop_date),
    ddd_sum = sum(ddd_per_prescription)
    ) %>% 
  mutate(ab_days_all = ab_stop_all - ab_start_all + 1) %>% 
  ungroup()

final_set <-
  final_set %>% left_join(
    select(
      final_set_cont,
      patient_number,
      adm_number,
      adm_year,
      ab_days_all,
      ab_start_all,
      ab_stop_all,
      ddd_sum
    )
  )


final_set$bc_date <- # new variable for blood culture dates
  if_else(condition = final_set$material == "blood", 
          true = final_set$test_date, 
          false = as.Date(NA_real_, origin = "1970-1-1"))

final_set$uc_date <- # new variable for urine culture dates
  if_else(condition = final_set$material == "urine", 
          true = final_set$test_date, 
          false = as.Date(NA_real_, origin = "1970-1-1"))
        
final_set <- final_set %>% 
  group_by(patient_number, adm_year, adm_number) %>% 
  mutate(bc_date = min(bc_date, na.rm = TRUE), # recode bc_date to include only first date of respective test
         uc_date = min(uc_date, na.rm = TRUE)
  ) %>%
  mutate(
    ab_timing  = ab_start_all - adm_start_date, # difference in days between admission and treatment start
    bc_timing = bc_date - ab_start_all,
    uc_timing = uc_date - ab_start_all) # difference in days between treatment start and first test


```


### Select required variables for RadaR

```{r}
final_set <- final_set %>% 
  select(
    patient_number, # together with adm_number and adm_year = unique identifier (ID or study ID)
    adm_number,
    adm_year, 
    adm_start_date,
    adm_end_date,
    LOS,
    gender,
    birth_date,
    sub_specialty,
    specialty,
    death_during_adm,
    adm_route,
    age,
    adm_weekday,
    year,
    yearquarter,
    test_date,
    material,
    bc_date,
    uc_date,
    bc_timing, 
    uc_timing,
    fullname,
    ab_type,
    ab_route, 
    atc_code,
    ab_type,
    ab_group,
    ab_start_date,
    ab_stop_date,
    ab_start_all,
    ab_stop_all,
    ab_days,
    ab_days_all,
    ab_timing,
    ab_first,
    ddd_per_prescription,
    ddd_sum
  )

write_csv(final_set,"final_set.csv")
```


